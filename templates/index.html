<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF8">
  <!-- <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js" type="text/javascript"></script>

  <!-- <meta http-equiv="content-type" content="text/html; charset=UTF8">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js" type="text/javascript"></script> -->
  <link rel="stylesheet" type="text/css" href="../static/css/dc.css" media="screen" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/css/bootstrap.min.css">
</head>

<body>
  <div>
    <h2>Bar Chart</h2></div>
  <!-- <div id="test"></div> -->
  <div id="barchart" class="reset"></div>
  <div id="piechart"></div>
  <div style='clear:both;'>
    <!-- <table id="tablechart" class="table-cell-center"> -->
    <table id="tablechart" class="table table-condensed">
      <thead>
        <tr class="header">
          <th>State</th>
          <th>Funding($)</th>
        </tr>
      </thead>
    </table>
  </div>
  <script>
    var text = '[';
    var obj;
    // var str;
    // var stateArray = [
    // "AK", "AL", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR",
    // "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"
    // ];
    url = "/funding";
    d3.json(url, function(error, json_response) {
      for (var item in json_response['proposals']) {
        item = parseInt(item);
        fund = json_response['proposals'][item]['totalPrice'];
        state = json_response['proposals'][item]['state'];
        obj = '{ "state":' + '"' + state + '"' + ', "fund":' + fund + '}';
        text += obj + ',';
      }
      text = text.substring(0, text.length - 1);
      text += ']';
      // document.getElementById("test").innerHTML = "<p>" + text + "</p>";
      data = JSON.parse(text);
      // document.getElementById("test2").innerHTML = "<p>" + data + "</p>";

      cf = crossfilter(data);
      barChart = dc.barChart("#barchart");
      pieChart = dc.pieChart("#piechart");
      stateDim = cf.dimension(function(d) {
        return d.state;
      });
      fundDim = stateDim.group().reduceSum(function(d) {
        return d.fund;
      });
      barChart
        .dimension(stateDim)
        .group(fundDim)
        .x(d3.scale.ordinal().domain(["AK", "AL", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND",
          "OH",
          "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"
        ]))
        .xUnits(dc.units.ordinal)
        .turnOnControls(true)
        .width(800).height(400)
        // .renderArea(true)
        .yAxisLabel("Funding by State")
        .xAxisLabel("State")
        // .brushOn(true) //for lineChart only
        .elasticX(true)
        // .renderHorizontalGridLines(true)
        // .shareColors(true)
        // .renderArea(true) //for lineChart only
        .xAxis().ticks(2);

      pieChart
        .width(450)
        .height(200)
        .slicesCap(50)
        .innerRadius(20)
        .dimension(stateDim)
        .group(fundDim)
        .turnOnControls(true)
        // .drawPaths(true)
        // .externalLabelRadius(50)

      var datatable = dc.dataTable("#tablechart");
      datatable
        .dimension(stateDim)
        .group(function(d) {
          return d.fund;
        })
        // .group(fundDim)
        .columns([
          function(d) {
            return d.state;
          },
          function(d) {
            return d.fund;
          }
        ]);

      dc.renderAll();
    });
  </script>
</body>

</html>
